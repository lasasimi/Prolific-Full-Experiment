{{ extends 'otree/WaitPage.html' }}
<link rel="stylesheet" href="{% static 'global/style.css' %}"/>
{{ block title }}
<!-- We leave this blank so the title can be fully handled inside content -->
{{ endblock }}

{{ block content }}


<style>
    body {
        background-color: #d3d3d3; /* Light gray background */
    }
    #game-area {
        width: 500px;
        height: 80px;
        border: 1px solid black;
        position: relative;
        margin: 20px auto;
        background-color: white;
    }
    #circle {
    width: 15px;
    height: 15px;
    border-radius: 50%; /* circle by default */
    background-color: rgb(255, 128, 0);
    position: absolute;
    cursor: pointer;
    display: flex;             /* only needed if using emoji/text inside */
    align-items: center;       /* center emoji vertically */
    justify-content: center;   /* center emoji horizontally */
    font-size: 14px;           /* size for emoji, optional */
    text-align: center;
}
</style>
<div class="yellow-box" style="text-align: center">
    <strong>ğŸš¨
    Do not leave this tab.</strong> Youâ€™ll hear a bell ring to remind you to go back to this tab and hit the refresh button.
</div>

<div class="wait-container">
    <!-- Notification message -->
   


    <!-- Centered Title -->
    <div class="custom-title">ğŸ•’ Waiting for a Group to Form</div>

    <p>You completed Phase 1! You are now waiting to be placed into a group with other participants for the interactive round (Phase 2).</p>
    <img src="/static/neighbors-new.png" class="img-fluid" alt="Meeting Neighbors Image" style="float:left; margin-right: 10px; max-width: 100%; height: 160px; "> 
    <p>ğŸ—“ï¸ Imagine that <strong>tomorrow</strong>, the next <strong>community meeting is going to happen.</strong>
        ğŸš¶ğŸ» Now, you are out for a walk. You notice that the neighbors seem to be <strong>talking about the dilemma.</strong></p>
        <p>ğŸ’­ In the next phase, <strong>you will meet various neighbors and get to hear about what they think.</strong>
        <strong>ğŸ—³ï¸ You could use this to make up your mind on what to choose</strong> in the upcoming meeting.</p>
        <p>ğŸ At the end of the rounds, you will see what your community decides on.</p>  
    <hr>

    <strong>âš ï¸ Important Information</strong>
    <ul>
    <li>You may wait up to <strong><span style="color: red;">20 minutes</span></strong> while your group is formed, <strong><span style="color: red;">do not leave this tab/window or you will be considered inactive</strong></span> and cannot be grouped.</li>
    <li>The next part of the study involves <strong>real-time interaction</strong> with others indicated by the <b>blipping (Live) ğŸ”´ text.</b></li> 
    </ul>

    <p class="green-box">
    The <strong><span style="color: rgb(21, 149, 1);">ğŸŸ¢ green circle</span></strong> on your browser tab indicates you are <strong><span style="color: rgb(21, 149, 1);">active</strong>.</p>
    <p class="yellow-box"> The <strong span style="color: rgb(157, 133, 10);"> ğŸŸ¡ yellow circle</strong span> on your browser tab indicates that you are <strong span style="color: rgb(157, 133, 10);">inactive. </strong></p>
    <b>Prevent being inactive</b> by ğŸ”„ refreshing the page or playing  this game ğŸ‘‡<br><hr>
    <!-- ğŸ‘‡ Mini Catch-the-Circle Game -->
    <div style="text-align:center;">
        <h5>ğŸ® Mini Game While You Wait</h5>
        <em>Catch the shape as many times as you can before it refreshes!  </em>

        <div id="game-area">
            <div id="circle"></div>
        </div>
        Score: <span id="score">0</span>
        ğŸ† High Score: <span id="highscore">0</span>
        <button id="refreshBtn" class="button button2">
            ğŸ”„ Refresh & Change Shape
        </button>
    </div>
    <hr>
    <strong>ğŸ”” After you are grouped:</strong>
    <ul><li>Stay at your <strong>browser tab/window</strong> and remain <strong>attentive</strong>.</li>
    <li>Stay <strong>active</strong> until the activity ends.</li>
    </li>
    </ul>
    <strong>ğŸ’° Total Payment:</strong>
    <ul>
    <li><strong>3.50 GBP</strong> if you complete the rounds.</li>
    <li><strong>2.50 GBP</strong> for waiting more than 20 minutes and is not formed.</li>
    </ul>

</div>




<script>
    let score = 0;
    const circle = document.getElementById("circle");
    const gameArea = document.getElementById("game-area");
    const scoreSpan = document.getElementById("score");
    const highScoreSpan = document.getElementById("highscore");

    // Load high score from browser storage
    let highScore = localStorage.getItem("circleHighScore") || 0;
    highScoreSpan.textContent = highScore;

    function moveCircle() {
        const areaWidth = gameArea.clientWidth - circle.clientWidth;
        const areaHeight = gameArea.clientHeight - circle.clientHeight;
        const newLeft = Math.floor(Math.random() * areaWidth);
        const newTop = Math.floor(Math.random() * areaHeight);
        circle.style.left = newLeft + "px";
        circle.style.top = newTop + "px";
    }

    circle.addEventListener("click", function () {
        score++;
        scoreSpan.textContent = score;
        moveCircle();

        // Update high score if current score is higher
        if (score > highScore) {
            highScore = score;
            highScoreSpan.textContent = highScore;
            localStorage.setItem("circleHighScore", highScore);
        }
    });
    
    function changeShapeAndColor() {
    // Shapes: circle, square, rounded square
    const shapes = ["50%", "0%", "20%"];
    const randomShape = shapes[Math.floor(Math.random() * shapes.length)];
    circle.style.borderRadius = randomShape;
    localStorage.setItem("circleShape", randomShape);

    // Colors: pick a random color
    const colors = ["rgb(255,128,0)", "rgb(0,128,255)", "rgb(128,0,255)", "rgb(0,200,0)", "rgb(255,0,128)"];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    circle.style.backgroundColor = randomColor;
    localStorage.setItem("circleColor", randomColor);
    }

    // Apply saved shape and color on page load
    const savedShape = localStorage.getItem("circleShape");
    if (savedShape) {
        circle.style.borderRadius = savedShape;
    }
    const savedColor = localStorage.getItem("circleColor");
    if (savedColor) {
        circle.style.backgroundColor = savedColor;
    }

    // Button click without delay
    refreshBtn.addEventListener("click", function () {
        changeShapeAndColor();
        window.location.reload(); // reloads immediately
    });

    // Start game loop
    moveCircle();
</script>

<script>
   function bellReady() {
   let audio = new Audio("{{ static 'bike-bell-ring-once.mp3' }}"); // correct file path
    audio.play();
  }

  if (document.hidden) {
    bellReady();
  }
    // Listen for tab visibility changes
    document.addEventListener("visibilitychange", function() {
        if (document.hidden) {
            bellReady();
        }
    });
</script>


{% if view.group_by_arrival_time %}
    <script>
        if (!window.reloadScheduled) {
            window.reloadScheduled = true;
            var SECOND = 1000;
            setInterval(function () {
                window.location.reload();
            }, 10 * SECOND); // reload every 10 seconds
        }
    </script>
{% endif %}

{{ endblock }}
